<div class="container mt-5">
    <div class="row">
        <div class="col-md-8 offset-md-2">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h3 class="text-center">Đặt vé xem phim</h3>
                </div>
                <div class="card-body" id="bookingContent">
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p>Đang tải thông tin...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    document.addEventListener('DOMContentLoaded', async () => {
        const bookingContent = document.getElementById('bookingContent');

        // Kiểm tra đăng nhập
        if (!auth || !auth.isLoggedIn()) {
            bookingContent.innerHTML = `
            <div class="alert alert-warning text-center">
                <h4>Vui lòng đăng nhập để đặt vé</h4>
                <p>Bạn cần đăng nhập để tiếp tục đặt vé xem phim</p>
                <div class="d-flex justify-content-center gap-3 mt-3">
                    <a href="/dangnhap" class="btn btn-primary">Đăng nhập</a>
                    <a href="/dangky" class="btn btn-outline-primary">Đăng ký</a>
                </div>
            </div>
        `;
            return;
        }

        // Lấy ID phim từ URL
        const urlParams = new URLSearchParams(window.location.search);
        const movieId = urlParams.get('id');

        if (!movieId) {
            bookingContent.innerHTML = `
            <div class="alert alert-danger text-center">
                <h4>Không tìm thấy phim</h4>
                <p>Vui lòng chọn phim từ trang chủ</p>
                <a href="/" class="btn btn-primary mt-2">Về trang chủ</a>
            </div>
        `;
            return;
        }

        try {
            // Lấy thông tin phim
            const response = await authFetch(`http://localhost:8080/api/movies/${movieId}`);

            if (!response.ok) {
                throw new Error('Không thể tải thông tin phim');
            }

            const movie = await response.json();

            // Lấy danh sách suất chiếu
            const showtimesResponse = await authFetch(`http://localhost:8080/api/showtimes?movieId=${movieId}`);

            if (!showtimesResponse.ok) {
                throw new Error('Không thể tải suất chiếu');
            }

            const showtimes = await showtimesResponse.json();

            // Hiển thị form đặt vé
            bookingContent.innerHTML = `
            <div class="row">
                <div class="col-md-4">
                    <img src="${movie.poster_url}" class="img-fluid rounded" 
                         onerror="this.src='https://via.placeholder.com/300x450?text=No+Image'">
                </div>
                <div class="col-md-8">
                    <h4>${movie.title}</h4>
                    <p>${movie.description || 'Không có mô tả'}</p>
                    <hr>
                    
                    <form id="bookingForm">
                        <input type="hidden" id="movieId" value="${movie.id}">
                        
                        <div class="mb-3">
                            <label class="form-label">Chọn suất chiếu:</label>
                            <select class="form-select" id="showtime" required>
                                <option value="" selected disabled>-- Chọn suất chiếu --</option>
                                ${showtimes.map(st => `
                                    <option value="${st.id}">
                                        ${new Date(st.start_time).toLocaleString()} - ${st.room?.name || 'Phòng không xác định'}
                                    </option>
                                `).join('')}
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Số lượng vé:</label>
                            <input type="number" class="form-control" id="quantity" min="1" max="10" value="1" required>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Chọn ghế:</label>
                            <div class="alert alert-info">
                                Bạn sẽ chọn ghế sau khi xác nhận thông tin
                            </div>
                        </div>
                        
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary btn-lg">Tiếp tục</button>
                        </div>
                    </form>
                </div>
            </div>
        `;

            // Xử lý submit form
            document.getElementById('bookingForm').addEventListener('submit', async (e) => {
                e.preventDefault();

                const showtimeId = document.getElementById('showtime').value;
                const quantity = document.getElementById('quantity').value;

                try {
                    const response = await authFetch('http://localhost:8080/api/bookings', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            showtimeId: showtimeId,
                            quantity: quantity,
                            movieId: movieId
                        })
                    });

                    if (response.ok) {
                        const booking = await response.json();
                        alert('Đặt vé thành công! Mã vé của bạn: ' + booking.bookingCode);
                        window.router.navigate('/tickets');
                    } else {
                        const error = await response.text();
                        alert('Đặt vé thất bại: ' + error);
                    }
                } catch (error) {
                    console.error('Lỗi khi đặt vé:', error);
                    alert('Có lỗi xảy ra khi đặt vé. Vui lòng thử lại sau.');
                }
            });

        } catch (error) {
            console.error('Lỗi:', error);
            bookingContent.innerHTML = `
            <div class="alert alert-danger text-center">
                <h4>Đã xảy ra lỗi</h4>
                <p>${error.message || 'Không thể tải thông tin đặt vé'}</p>
                <a href="/" class="btn btn-primary mt-2">Về trang chủ</a>
            </div>
        `;
        }
    });
</script>